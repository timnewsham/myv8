#!/usr/bin/env expect
#
# Fixup proto-v8 disk rp0v8_prep to be a proper v8 system on rp0v8
#

source common.tcl

# for testing
exec cp rp06v8_prep rp06v8

proc boot { } {
    simh "set tto 7b"
    simh "set dz lines=8"
    simh "set rp0 rp06"
    simh "at rp0 rp06v8"
    simh "set tu0 te16"
    simh "load -o bootV8 0"
    simh "run 2"
}
proc shutdown { } {
    unix "sync; sync; sync"
    unix "/etc/halt"
    simh "exit"
    expect eof
}

# convert FS to v8
spawn vax780
boot
unix "/etc/fsck -y /dev/rrp0a"
unix "/etc/fsck -y /dev/rrp0g"
shutdown

# some FS setup
spawn vax780
boot
unix "/etc/fsck -y /dev/rrp0a"
unix "/etc/fsck -y /dev/rrp0g"
unix "cat > /etc/fstab"
sendline "/dev/rp0a:/:rw:1:1"
sendline "/dev/rp0g:/usr:rw:1:2"
send $ctrlD
unix "/etc/mount -a"
unix "mkdir /proc"
unix "mkdir /usr/adm"
unix "mkdir /usr/tmp"

# rebuild /dev
unix "rm -f /dev/*"
unix "/etc/mknod /dev/rp0a b 0 0"
unix "chmod 600 /dev/rp0a"
unix "/etc/mknod /dev/rrp0a c 4 0"
unix "chmod 600 /dev/rrp0a"
unix "/etc/mknod /dev/rp0g b 0 6"
unix "chmod 600 /dev/rp0g"
unix "/etc/mknod /dev/rrp0g c 4 6"
unix "chmod 600 /dev/rrp0g"
unix "/etc/mknod /dev/console c 0 0"
unix "chmod 622 /dev/console"
unix "/etc/chown root,0 /dev/console"
unix "mkdir /dev/dk"
unix "chmod 775 /dev/dk"
unix "/etc/chown root,sys /dev/dk"
unix "/etc/mknod /dev/dn0 c 19 128"
unix "chmod 666 /dev/dn0"
unix "/etc/chown root,bin /dev/dn0"
unix "/etc/mknod /dev/drum c 7 0"
unix "chmod 644 /dev/drum"
unix "/etc/chown root,man /dev/drum"
unix "mkdir /dev/fd"
unix "chmod 755 /dev/fd"
unix "/etc/chown root,other /dev/fd"
unix "/etc/mknod /dev/ip0 c 42 0"
unix "chmod 666 /dev/ip0"
unix "/etc/chown root,bin /dev/ip0"
unix "/etc/mknod /dev/ip16 c 42 16"
unix "chmod 666 /dev/ip16"
unix "/etc/chown root,bin /dev/ip16"
unix "/etc/mknod /dev/ip17 c 42 17"
unix "chmod 666 /dev/ip17"
unix "/etc/chown root,bin /dev/ip17"
unix "/etc/mknod /dev/ip6 c 42 6"
unix "chmod 666 /dev/ip6"
unix "/etc/chown root,bin /dev/ip6"
unix "/etc/mknod /dev/kUmem c 3 3"
unix "chmod 600 /dev/kUmem"
unix "/etc/chown root,sys /dev/kUmem"
unix "/etc/mknod /dev/kmc0 c 26 0"
unix "chmod 666 /dev/kmc0"
unix "/etc/chown root,sys /dev/kmc0"
unix "/etc/mknod /dev/kmem c 3 1"
unix "chmod 644 /dev/kmem"
unix "/etc/chown root,sys /dev/kmem"
unix "/etc/mknod /dev/kmemr c 3 4"
unix "chmod 444 /dev/kmemr"
unix "/etc/chown root,bin /dev/kmemr"
unix "/etc/mknod /dev/mem c 3 0"
unix "chmod 644 /dev/mem"
unix "/etc/chown root,sys /dev/mem"
unix "/etc/mknod /dev/mt1 b 8 0"
unix "chmod 666 /dev/mt1"
unix "/etc/chown root,sys /dev/mt1"
unix "/etc/mknod /dev/mt2 b 8 8"
unix "chmod 666 /dev/mt2"
unix "/etc/chown root,sys /dev/mt2"
unix "/etc/mknod /dev/mt5 b 8 4"
unix "chmod 666 /dev/mt5"
unix "/etc/chown root,sys /dev/mt5"
unix "/etc/mknod /dev/mt6 b 8 12"
unix "chmod 666 /dev/mt6"
unix "/etc/chown root,sys /dev/mt6"
unix "/etc/mknod /dev/mtpr c 3 5"
unix "chmod 600 /dev/mtpr"
unix "/etc/chown root,0 /dev/mtpr"
unix "/etc/mknod /dev/nmt1 b 8 4"
unix "chmod 666 /dev/nmt1"
unix "/etc/chown root,sys /dev/nmt1"
unix "/etc/mknod /dev/nmt2 b 8 12"
unix "chmod 666 /dev/nmt2"
unix "/etc/chown root,sys /dev/nmt2"
unix "/etc/mknod /dev/nrmt1 c 22 4"
unix "chmod 666 /dev/nrmt1"
unix "/etc/chown root,sys /dev/nrmt1"
unix "/etc/mknod /dev/nrmt2 c 22 12"
unix "chmod 666 /dev/nrmt2"
unix "/etc/chown root,sys /dev/nrmt2"
unix "/etc/mknod /dev/null c 3 2"
unix "chmod 666 /dev/null"
unix "/etc/chown root,man /dev/null"
unix "mkdir /dev/pt"
unix "chmod 755 /dev/pt"
unix "/etc/chown pjw,other /dev/pt"
unix "/etc/mknod /dev/ra00 b 7 64"
unix "chmod 640 /dev/ra00"
unix "/etc/chown root,sys /dev/ra00"
unix "/etc/mknod /dev/ra01 b 7 1"
unix "chmod 640 /dev/ra01"
unix "/etc/chown root,sys /dev/ra01"
unix "/etc/mknod /dev/ra02 b 7 66"
unix "chmod 640 /dev/ra02"
unix "/etc/chown root,sys /dev/ra02"
unix "/etc/mknod /dev/ra03 b 7 67"
unix "chmod 640 /dev/ra03"
unix "/etc/chown root,sys /dev/ra03"
unix "/etc/mknod /dev/ra04 b 7 68"
unix "chmod 640 /dev/ra04"
unix "/etc/chown root,sys /dev/ra04"
unix "/etc/mknod /dev/ra05 b 7 69"
unix "chmod 640 /dev/ra05"
unix "/etc/chown root,sys /dev/ra05"
unix "/etc/mknod /dev/ra06 b 7 70"
unix "chmod 640 /dev/ra06"
unix "/etc/chown root,sys /dev/ra06"
unix "/etc/mknod /dev/ra10 b 7 72"
unix "chmod 640 /dev/ra10"
unix "/etc/chown root,sys /dev/ra10"
unix "/etc/mknod /dev/ra11 b 7 9"
unix "chmod 640 /dev/ra11"
unix "/etc/chown root,sys /dev/ra11"
unix "/etc/mknod /dev/ra12 b 7 74"
unix "chmod 640 /dev/ra12"
unix "/etc/chown root,sys /dev/ra12"
unix "/etc/mknod /dev/ra13 b 7 75"
unix "chmod 640 /dev/ra13"
unix "/etc/chown root,sys /dev/ra13"
unix "/etc/mknod /dev/ra14 b 7 76"
unix "chmod 640 /dev/ra14"
unix "/etc/chown root,sys /dev/ra14"
unix "/etc/mknod /dev/ra15 b 7 77"
unix "chmod 640 /dev/ra15"
unix "/etc/chown root,sys /dev/ra15"
unix "/etc/mknod /dev/ra16 b 7 78"
unix "chmod 640 /dev/ra16"
unix "/etc/chown root,sys /dev/ra16"
unix "/etc/mknod /dev/ra20a b 7 80"
unix "chmod 664 /dev/ra20a"
unix "/etc/chown root,bin /dev/ra20a"
unix "/etc/mknod /dev/ra21 b 7 17"
unix "chmod 640 /dev/ra21"
unix "/etc/chown root,sys /dev/ra21"
unix "/etc/mknod /dev/ra22 b 7 18"
unix "chmod 664 /dev/ra22"
unix "/etc/chown root,bin /dev/ra22"
unix "/etc/mknod /dev/ra23 b 7 83"
unix "chmod 640 /dev/ra23"
unix "/etc/chown root,sys /dev/ra23"
unix "/etc/mknod /dev/ra24 b 7 84"
unix "chmod 640 /dev/ra24"
unix "/etc/chown root,sys /dev/ra24"
unix "/etc/mknod /dev/ra25 b 7 85"
unix "chmod 640 /dev/ra25"
unix "/etc/chown root,sys /dev/ra25"
unix "/etc/mknod /dev/ra26 b 7 22"
unix "chmod 640 /dev/ra26"
unix "/etc/chown root,sys /dev/ra26"
unix "/etc/mknod /dev/rmt1 c 22 0"
unix "chmod 666 /dev/rmt1"
unix "/etc/chown root,sys /dev/rmt1"
unix "/etc/mknod /dev/rmt2 c 22 8"
unix "chmod 666 /dev/rmt2"
unix "/etc/chown root,sys /dev/rmt2"
unix "/etc/mknod /dev/rmt5 c 22 4"
unix "chmod 666 /dev/rmt5"
unix "/etc/chown root,sys /dev/rmt5"
unix "/etc/mknod /dev/rmt6 c 22 12"
unix "chmod 666 /dev/rmt6"
unix "/etc/chown root,sys /dev/rmt6"
unix "/etc/mknod /dev/rra00 c 28 0"
unix "chmod 640 /dev/rra00"
unix "/etc/chown root,sys /dev/rra00"
unix "/etc/mknod /dev/rra01 c 28 1"
unix "chmod 640 /dev/rra01"
unix "/etc/chown root,sys /dev/rra01"
unix "/etc/mknod /dev/rra02 c 28 2"
unix "chmod 640 /dev/rra02"
unix "/etc/chown root,sys /dev/rra02"
unix "/etc/mknod /dev/rra03 c 28 3"
unix "chmod 640 /dev/rra03"
unix "/etc/chown root,sys /dev/rra03"
unix "/etc/mknod /dev/rra04 c 28 4"
unix "chmod 640 /dev/rra04"
unix "/etc/chown root,sys /dev/rra04"
unix "/etc/mknod /dev/rra05 c 28 5"
unix "chmod 640 /dev/rra05"
unix "/etc/chown root,sys /dev/rra05"
unix "/etc/mknod /dev/rra06 c 28 6"
unix "chmod 640 /dev/rra06"
unix "/etc/chown root,sys /dev/rra06"
unix "/etc/mknod /dev/rra07 c 28 7"
unix "chmod 640 /dev/rra07"
unix "/etc/chown root,sys /dev/rra07"
unix "/etc/mknod /dev/rra10 c 28 8"
unix "chmod 660 /dev/rra10"
unix "/etc/chown root,sys /dev/rra10"
unix "/etc/mknod /dev/rra11 c 28 9"
unix "chmod 640 /dev/rra11"
unix "/etc/chown root,sys /dev/rra11"
unix "/etc/mknod /dev/rra12 c 28 10"
unix "chmod 640 /dev/rra12"
unix "/etc/chown root,sys /dev/rra12"
unix "/etc/mknod /dev/rra13 c 28 11"
unix "chmod 640 /dev/rra13"
unix "/etc/chown root,sys /dev/rra13"
unix "/etc/mknod /dev/rra14 c 28 12"
unix "chmod 640 /dev/rra14"
unix "/etc/chown root,sys /dev/rra14"
unix "/etc/mknod /dev/rra15 c 28 13"
unix "chmod 640 /dev/rra15"
unix "/etc/chown root,sys /dev/rra15"
unix "/etc/mknod /dev/rra16 c 28 14"
unix "chmod 660 /dev/rra16"
unix "/etc/chown root,sys /dev/rra16"
unix "/etc/mknod /dev/rra17 c 28 15"
unix "chmod 640 /dev/rra17"
unix "/etc/chown root,sys /dev/rra17"
unix "/etc/mknod /dev/rra20 c 28 16"
unix "chmod 640 /dev/rra20"
unix "/etc/chown root,sys /dev/rra20"
unix "/etc/mknod /dev/rra21 c 28 17"
unix "chmod 640 /dev/rra21"
unix "/etc/chown root,sys /dev/rra21"
unix "/etc/mknod /dev/rra22 c 28 18"
unix "chmod 640 /dev/rra22"
unix "/etc/chown root,sys /dev/rra22"
unix "/etc/mknod /dev/rra23 c 28 19"
unix "chmod 640 /dev/rra23"
unix "/etc/chown root,sys /dev/rra23"
unix "/etc/mknod /dev/rra24 c 28 20"
unix "chmod 640 /dev/rra24"
unix "/etc/chown root,sys /dev/rra24"
unix "/etc/mknod /dev/rra25 c 28 21"
unix "chmod 640 /dev/rra25"
unix "/etc/chown root,sys /dev/rra25"
unix "/etc/mknod /dev/rra26 c 28 22"
unix "chmod 640 /dev/rra26"
unix "/etc/chown root,sys /dev/rra26"
unix "/etc/mknod /dev/rra27 c 28 23"
unix "chmod 640 /dev/rra27"
unix "/etc/chown root,sys /dev/rra27"
unix "/etc/mknod /dev/stderr c 40 2"
unix "chmod 666 /dev/stderr"
unix "/etc/chown root,other /dev/stderr"
unix "/etc/mknod /dev/stdin c 40 0"
unix "chmod 666 /dev/stdin"
unix "/etc/chown root,other /dev/stdin"
unix "/etc/mknod /dev/stdout c 40 1"
unix "chmod 666 /dev/stdout"
unix "/etc/chown root,other /dev/stdout"

unix "/etc/mknod /dev/tty c 40 3"
unix "chmod 666 /dev/tty"
unix "/etc/chown root,other /dev/tty"

# note: the perms and owners were not this uniform.  revisit these. XXX
unix "for n in 00 01 02 03 04 05 06 07 09 10 11; do /etc/mknod /dev/tcp\$n c 43 \$n; chmod 666 /dev/tcp\$n; /etc/chown root,bin /dev/tcp\$n; done"

unix "for n in 00 01 02 03 04 05 06 07; do /etc/mknod /dev/tty\$n c 1 \$n; chmod 622 /dev/tty\$n; /etc/chown root,0 /dev/tty\$n; done"

unix "for n in 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95; do /etc/mknod /dev/dk/dk\$n c 31 \$n; chmod 666 /dev/dk/dk\$n; /etc/chown root,sys /dev/dk/dk\$n; done"

unix "for n in 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 ; do /etc/mknod /dev/fd/\$n c 40 \$n; chmod 666 /dev/fd/\$n; /etc/chown root,other /dev/fd/\$n; done"
unix "for n in 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 ; do /etc/mknod /dev/fd/\$n c 40 \$n; chmod 666 /dev/fd/\$n; /etc/chown root,other /dev/fd/\$n; done"

unix "for n in 00 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 ; do /etc/mknod /dev/pt/pt\$n c 18 \$n; chmod 666 /dev/pt/pt\$n; /etc/chown root,sys /dev/pt/pt\$n; done"

# enable login on serial ttys
unix "ed /etc/ttys"
sendline "2,25d"
sendline "2i"
sendline "12tty00"
sendline "12tty01"
sendline "12tty02"
sendline "12tty03"
sendline "12tty04"
sendline "12tty05"
sendline "12tty06"
sendline "12tty07"
sendline "."
sendline "w"
sendline "q"

# enable networking in kernel
unix "cd /usr/sys/alice"
unix "cat >> conf"
sendline "pseudo-device   inet    6"
sendline "pseudo-device   uarp    1"
sendline "pseudo-device   tcp     32"
sendline "pseudo-device   udp     32"
send $ctrlD
unix "/etc/config"
unix "make"
unix "cp unix /"
unix "make clean"

# install network commands
unix "PATH=/bin:/usr/bin:/etc; export PATH"
unix "cd /usr/src/cmd/inet/libin; make install"
unix "cd ../bin && make install && make clean"
unix "cd ../etc && make install && make clean"

unix "cd /"
unix "umount /dev/rp0g"
shutdown

